<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8">
  <title>Utleiestatistikk Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body { margin: 20px; background:#f9f9f9; }
    h1 { margin: 0 0 12px 0; }
    .muted { color:#666; font-size:14px; margin-bottom:16px; }
    .row { display:flex; gap:20px; flex-wrap:wrap; }
    .card { border:1px solid #e5e5e5; border-radius:8px; padding:14px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.04); flex:1 1 100%; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 12px; border-top:1px solid #eee; }
    th { text-align:left; background:#fafafa; position:sticky; top:0; z-index:1; }
    td.right, th.right { text-align:right; }
    .controls { display:flex; gap:14px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    select, input[type="text"] { padding:8px 10px; border:1px solid #ddd; border-radius:8px; min-width:220px; }
    .pill { background:#f4f4f4; padding:6px 10px; border-radius:999px; font-size:12px; }
    .small { font-size:12px; color:#666; }
    a { color:#0a58ca; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .scroll { max-height:420px; overflow:auto; }
    canvas { max-width:100%; height:300px; }
  </style>
</head>
<body>
  <h1>Markeder</h1>
  <div id="marketCount" class="muted"></div>

  <div class="controls">
    <label>Velg marked
      <select id="marketSelect"></select>
    </label>
    <label>Søk i liste
      <input id="searchInput" type="text" placeholder="Søk tittel, adresse eller postnr">
    </label>
    <span id="snapshotBadge" class="pill"></span>
  </div>

  <div class="card">
    <h2>Oversikt</h2>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>Marked</th>
          <th>Dato</th>
          <th class="right">Antall</th>
          <th class="right">Snitt pris</th>
          <th class="right">Snitt kvm</th>
          <th class="right">Snitt pris per kvm</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="row" style="margin-top:20px;">
    <div class="card">
      <h2>Detaljer for valgt marked</h2>
      <div class="small" id="detailSub"></div>
      <div class="scroll">
        <table id="detailTable">
          <thead>
            <tr>
              <th>Tittel</th>
              <th>Adresse</th>
              <th>Postnr</th>
              <th>By</th>
              <th class="right">Kvm</th>
              <th class="right">Soverom</th>
              <th class="right">Pris NOK</th>
              <th class="right">Pris per kvm</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:20px;">
    <div class="card">
      <h2>Snitt per antall soverom</h2>
      <div id="bedsTableWrap"></div>
      <canvas id="bedsChart"></canvas>
    </div>
  </div>

  <div class="row" style="margin-top:20px;">
    <div class="card">
      <h2>Snittpris per marked</h2>
      <canvas id="marketChart"></canvas>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const base = (location.origin + location.pathname).replace(/\/$/, '');
const SUMMARY_PATH = base + '/data/summaries/markets_summary.csv';
const BEDS_PATH    = base + '/data/summaries/markets_by_bedrooms.csv';

let allSummary = [];
let currentMarket = null;
let currentSnapshotFile = null;
let currentRows = [];

let marketChart, bedsChart;

function numberFormat(v) {
  if (!v || isNaN(+v)) return '';
  return (+v).toLocaleString('no-NO', { maximumFractionDigits: 0 });
}

async function fetchCSV(url) {
  const res = await fetch(url + '?cache=' + Date.now());
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const text = await res.text();
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(',').map(h => h.trim());
  const data = lines.map(line => {
    const cells = line.split(',').map(s => s.trim());
    const row = {};
    headers.forEach((h,i)=> row[h] = cells[i] ?? '');
    return row;
  });
  return { headers, data };
}

function renderSummaryTable(rows) {
  const tb = document.querySelector('#summaryTable tbody');
  tb.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.market_key}</td>
      <td>${r.snapshot_date}</td>
      <td class="right">${numberFormat(r.listings)}</td>
      <td class="right">${numberFormat(r.avg_price)}</td>
      <td class="right">${numberFormat(r.avg_sqm)}</td>
      <td class="right">${numberFormat(r.avg_price_per_sqm)}</td>
    `;
    tb.appendChild(tr);
  });
  document.getElementById('marketCount').textContent = `Antall markeder: ${rows.length}`;
}

function renderDetailTable(rows) {
  const tb = document.querySelector('#detailTable tbody');
  tb.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="${r.url}" target="_blank">${r.title || 'Bildegalleri'}</a></td>
      <td>${r.address || ''}</td>
      <td>${r.postal_code || ''}</td>
      <td>${r.city || ''}</td>
      <td class="right">${numberFormat(r.sqm)}</td>
      <td class="right">${numberFormat(r.bedrooms)}</td>
      <td class="right">${numberFormat(r.price_nok)}</td>
      <td class="right">${numberFormat(r.price_per_sqm)}</td>
    `;
    tb.appendChild(tr);
  });
}

// ----------- Grafer ---------------
function drawMarketChart(rows) {
  const ctx = document.getElementById('marketChart').getContext('2d');
  if (marketChart) marketChart.destroy();
  marketChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: rows.map(r=>r.market_key),
      datasets: [{
        label: 'Snittpris per marked (NOK)',
        data: rows.map(r=>+r.avg_price||0),
        backgroundColor: '#0a58ca'
      }]
    },
    options: { responsive:true, plugins:{ legend:{display:false} } }
  });
}

function drawBedsChart(rows) {
  const ctx = document.getElementById('bedsChart').getContext('2d');
  if (bedsChart) bedsChart.destroy();
  bedsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: rows.map(r=>`${r.bedrooms} soverom`),
      datasets: [{
        label: 'Snittpris (NOK)',
        data: rows.map(r=>+r.avg_price||0),
        backgroundColor: '#198754'
      }]
    },
    options: { responsive:true, plugins:{ legend:{display:false} } }
  });
}

// ----------- Per soverom-tabell ---------------
function renderBedsTable(rows) {
  const wrap = document.getElementById('bedsTableWrap');
  wrap.innerHTML = '';
  const tbl = document.createElement('table');
  tbl.innerHTML = `
    <thead><tr>
      <th class="right">Soverom</th>
      <th class="right">Antall</th>
      <th class="right">Snitt pris</th>
      <th class="right">Snitt kvm</th>
      <th class="right">Snitt pris/kvm</th>
    </tr></thead>
    <tbody></tbody>`;
  const tb = tbl.querySelector('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="right">${numberFormat(r.bedrooms)}</td>
      <td class="right">${numberFormat(r.listings)}</td>
      <td class="right">${numberFormat(r.avg_price)}</td>
      <td class="right">${numberFormat(r.avg_sqm)}</td>
      <td class="right">${numberFormat(r.avg_price_per_sqm)}</td>
    `;
    tb.appendChild(tr);
  });
  wrap.appendChild(tbl);
}

// ----------- Loaders ---------------
async function loadBedsSummary(marketKey) {
  const { data } = await fetchCSV(BEDS_PATH);
  const rows = data.filter(r => r.market_key === marketKey);
  rows.sort((a,b)=> (+a.bedrooms||0) - (+b.bedrooms||0));
  renderBedsTable(rows);
  drawBedsChart(rows);
}

async function loadMarketDetail() {
  if (!currentSnapshotFile) {
    document.querySelector('#detailTable tbody').innerHTML = '';
    return;
  }
  const path = base + '/data/snapshots/' + currentSnapshotFile;
  const { data } = await fetchCSV(path);
  const rows = data.filter(r => r.market_key === currentMarket);
  currentRows = rows;
  renderDetailTable(rows);
  document.getElementById('detailSub').textContent = `Viser ${rows.length} annonser for ${currentMarket}.`;
}

async function init() {
  try {
    const { data } = await fetchCSV(SUMMARY_PATH);
    allSummary = data;
    renderSummaryTable(allSummary);
    drawMarketChart(allSummary);

    // fyll select
    const sel = document.getElementById('marketSelect');
    sel.innerHTML = '';
    data.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.market_key;
      opt.textContent = r.market_key;
      sel.appendChild(opt);
    });

    currentMarket = data[0]?.market_key;
    currentSnapshotFile = data[0]?.snapshot_file;
    sel.value = currentMarket;
    document.getElementById('snapshotBadge').textContent = currentSnapshotFile || '';

    await loadMarketDetail();
    await loadBedsSummary(currentMarket);

    sel.addEventListener('change', async (e)=>{
      currentMarket = e.target.value;
      const row = allSummary.find(x=>x.market_key===currentMarket);
      currentSnapshotFile = row?.snapshot_file;
      document.getElementById('snapshotBadge').textContent = currentSnapshotFile || '';
      await loadMarketDetail();
      await loadBedsSummary(currentMarket);
      document.getElementById('searchInput').value = '';
    });

    document.getElementById('searchInput').addEventListener('input', e=>{
      const q = e.target.value.trim().toLowerCase();
      if (!q) return renderDetailTable(currentRows);
      const filtered = currentRows.filter(r =>
        (r.title||'').toLowerCase().includes(q) ||
        (r.address||'').toLowerCase().includes(q) ||
        (r.postal_code||'').toLowerCase().includes(q)
      );
      renderDetailTable(filtered);
    });
  } catch(e) {
    console.error(e);
    document.getElementById('marketCount').textContent = 'Klarte ikke å laste data.';
  }
}

init();
</script>
</body>
</html>
